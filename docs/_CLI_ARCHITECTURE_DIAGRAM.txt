â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                       RIFF CLI v2.0 - ARCHITECTURE MAP                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SOURCE CODE ORGANIZATION:
========================

/Users/tryk/nabia/tools/riff-cli/src/riff/
â”‚
â”œâ”€ cli.py (286 lines)
â”‚  â”‚
â”‚  â”œâ”€ build_parser()
â”‚  â”‚  â””â”€ 9 Subcommands:
â”‚  â”‚     â”œâ”€ search        (NEW: semantic)   â†’ cmd_search()
â”‚  â”‚     â”œâ”€ browse        (NEW: vim-style)  â†’ cmd_browse()
â”‚  â”‚     â”œâ”€ graph         (NEW: DAG viz)    â†’ cmd_graph()
â”‚  â”‚     â”œâ”€ sync:surreal  (NEW: phase 6B)   â†’ cmd_sync_surrealdb()
â”‚  â”‚     â”œâ”€ scan          (CLASSIC)         â†’ cmd_scan()
â”‚  â”‚     â”œâ”€ fix           (CLASSIC)         â†’ cmd_fix()
â”‚  â”‚     â”œâ”€ tui           (CLASSIC)         â†’ cmd_tui()
â”‚  â”‚     â””â”€ graph-classic (CLASSIC)         â†’ cmd_graph_classic()
â”‚  â”‚
â”‚  â””â”€ main()  [entry point]
â”‚
â”œâ”€ search/
â”‚  â”œâ”€ qdrant.py          â† Vector search backend (384-dim embeddings)
â”‚  â””â”€ preview.py         â† Content rendering + hooks filtering
â”‚
â”œâ”€ classic/
â”‚  â”œâ”€ commands/scan.py   â† JSONL file analysis
â”‚  â”œâ”€ commands/fix.py    â† JSONL repair (missing tool_result)
â”‚  â”œâ”€ commands/tui.py    â† Interactive file browser
â”‚  â”œâ”€ commands/graph.py  â† Mermaid/DOT graph generation
â”‚  â””â”€ utils.py           â† Helper functions
â”‚
â”œâ”€ enhance/
â”‚  â””â”€ intent.py          â† AI query enhancement + intent detection
â”‚
â”œâ”€ graph/
â”‚  â”œâ”€ dag.py             â† Conversation DAG (directed acyclic)
â”‚  â”œâ”€ loaders.py         â† JSONL loading logic
â”‚  â”œâ”€ models.py          â† Data structures (Session, Message, Thread)
â”‚  â”œâ”€ visualizer.py      â† ASCII tree rendering
â”‚  â”œâ”€ persistence.py     â† Generic persistence interface
â”‚  â”œâ”€ repair.py          â† Repair algorithms
â”‚  â””â”€ repair_manager.py  â† Repair orchestration
â”‚
â”œâ”€ tui/
â”‚  â”œâ”€ interface.py       â† Abstract TUI interface
â”‚  â”œâ”€ prompt_toolkit_impl.py  â† PromptToolkit implementation (MVP)
â”‚  â””â”€ graph_navigator.py â† Graph navigation logic
â”‚
â””â”€ surrealdb/            [PHASE 6B: IMMUTABLE EVENT STORE]
   â”œâ”€ storage.py         â† HTTP API client
   â”œâ”€ schema.sql         â† Database schema (14+ tables)
   â”œâ”€ repair_provider.py â† Event logging
   â”œâ”€ schema_utils.py    â† Schema helpers
   â”œâ”€ repair_events_utils.py  â† Query builders
   â””â”€ (tests, examples, docs)


COMMAND EXECUTION FLOW:
======================

User Input
    â”‚
    â”œâ”€ riff search "query"
    â”œâ”€ riff graph SESSION_ID
    â”œâ”€ riff sync:surrealdb SESSION
    â””â”€ riff [classic-commands]
    â”‚
    â–¼
cli.py::main()
    â”‚
    â–¼
build_parser() â†’ parse_args()
    â”‚
    â–¼
dispatch to cmd_*() based on args.command
    â”‚
    â”œâ”€ cmd_search()
    â”‚  â”‚
    â”‚  â”œâ”€ QdrantSearcher.search()
    â”‚  â”‚  â””â”€ Vector embedding + similarity search
    â”‚  â”‚
    â”‚  â””â”€ ContentPreview.display_search_results()
    â”‚     â””â”€ Render with content snippets
    â”‚
    â”œâ”€ cmd_graph()
    â”‚  â”‚
    â”‚  â”œâ”€ JSONLLoader.load_messages()
    â”‚  â”‚
    â”‚  â”œâ”€ ConversationDAG()
    â”‚  â”‚  â””â”€ Build graph from messages
    â”‚  â”‚
    â”‚  â””â”€ ConversationGraphNavigator.run()  (TUI)
    â”‚     OR ConversationTreeVisualizer.render_ascii_tree()
    â”‚
    â”œâ”€ cmd_sync_surrealdb()
    â”‚  â”‚
    â”‚  â”œâ”€ Load JSONL
    â”‚  â”œâ”€ Detect changes (hash comparison)
    â”‚  â”œâ”€ Connect to SurrealDB (async/ws)
    â”‚  â”œâ”€ Log repair events (immutable)
    â”‚  â””â”€ Sync messages
    â”‚
    â””â”€ [classic commands...]


FLAG ANALYSIS (NO CONFLICTS):
=============================

search:
  query         - Positional
  --limit       - int (default: 10)
  --min-score   - float (default: 0.3)
  --uuid        - boolean
  --ai          - boolean
  --days        - int
  --since       - str (ISO 8601)
  --until       - str (ISO 8601)

graph:
  session_id        - Positional
  --interactive     - boolean (default: True)
  --no-interactive  - boolean
  --surrealdb-url   - str

graph-classic:
  path          - Positional
  --format      - enum [dot, mermaid]  â† NO SHORT -f OPTION
  --out         - str

scan:
  target        - Positional (optional, default: .)
  --glob        - str (default: **/*.jsonl)
  --show        - boolean

fix:
  path          - Positional
  --in-place    - boolean

tui:
  target        - Positional (optional, default: .)
  --glob        - str (default: **/*.jsonl)
  --fzf         - boolean

sync:surrealdb:
  session_id        - Positional
  --force           - boolean
  --dry-run         - boolean
  --operator        - str (default: cli)
  --surrealdb-url   - str

browse:
  query         - Positional (optional)
  --limit       - int (default: 20)

GLOBAL:
  --qdrant-url  - str (default: http://localhost:6333)


KEY DESIGN DECISIONS:
====================

1. THREE-LAYER ARCHITECTURE:
   CLI Layer (cli.py) â†’ Business Logic â†’ Integration (SurrealDB/JSONL)

2. MODULAR TUI:
   Abstract interface â†’ PromptToolkit (MVP) â†’ Future swappable implementations

3. SEARCH BACKEND:
   Pluggable design: Qdrant (current) + extensible for other backends

4. IMMUTABLE EVENT STORE:
   SurrealDB for Phase 6B: Append-only repair events, never update history

5. TIME FILTERING:
   --days N, --since DATE, --until DATE for temporal queries


INTEGRATION WITH NABI:
======================

STATUS: Not yet wired in nabi-python script

PLAN:
  1. nabi exec riff â†’ route via nabi-python
  2. nabi-python detects "riff" commander
  3. Calls: /Users/tryk/nabia/tools/riff-cli/src/riff/cli.py
  4. Full riff functionality available via nabi CLI

CURRENT STATUS:
  Direct usage:  âœ“ riff search, riff graph, etc. work
  Via nabi:      âŠ— Not yet routed (implementation pending)


PROJECT STATUS:
===============

Version:     2.0.0
Language:    Python 3.13+
Framework:   argparse (standard library)
Package Mgr: uv

Week 1:  âœ… Complete
  - Clean architecture
  - Docker + Qdrant config
  - Search implementation
  - Documentation

Week 2:  ğŸš§ In Progress
  - TUI module refinement
  - Interactive navigator
  - Integration testing

Week 3:  ğŸ“… Planned
  - Default TUI integration
  - Performance optimization

Week 4:  ğŸ“… Planned
  - Production polish
  - Deployment


KEY FILES:
==========

/Users/tryk/nabia/tools/riff-cli/
â”œâ”€ src/riff/cli.py                    â† START HERE (main entry, all commands)
â”œâ”€ README.md                           â† Quick start guide
â”œâ”€ pyproject.toml                      â† Dependencies (uv config)
â”œâ”€ Taskfile.yml                        â† Task automation
â””â”€ docs/
   â”œâ”€ ARCHITECTURE.md                  â† System design
   â”œâ”€ usage.md                         â† Command reference
   â”œâ”€ PHASE_6B_*.md                    â† Persistence details
   â””â”€ (30+ other implementation docs)

